<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Планировщик дел</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Планировщик дел</h1>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="month-selector">
                    <button onclick="changeMonth(-1)">◄</button>
                    <h2 id="currentMonth"></h2>
                    <button onclick="changeMonth(1)">►</button>
                </div>
                <table class="calendar" id="calendar">
                    <thead>
                        <tr>
                            <th>Пн</th>
                            <th>Вт</th>
                            <th>Ср</th>
                            <th>Чт</th>
                            <th>Пт</th>
                            <th>Сб</th>
                            <th>Вс</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>

            <div class="day-panel">
                <h3 id="selectedDate">Выберите день</h3>
                <button class="add-task-btn" onclick="showAddTaskModal()">Добавить дело</button>
                <ul class="task-list" id="taskList"></ul>
            </div>
        </div>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="modalTitle">Новое дело</h3>
            <form id="taskForm">
                <div class="form-group">
                    <label>Тип дела</label>
                    <select id="taskType" onchange="toggleRecurringOptions()">
                        <option value="single">Разовое</option>
                        <option value="recurring">Периодическое</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Заголовок*</label>
                    <input type="text" id="taskTitle" required>
                </div>

                <div class="form-group">
                    <label>Время*</label>
                    <input type="time" id="taskTime" required>
                </div>

                <div class="form-group">
                    <label>Длительность (в минутах)</label>
                    <input type="number" id="taskDuration" min="0">
                </div>

                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="taskDescription"></textarea>
                </div>

                <div class="form-group" id="singleDateGroup">
                    <label>Дата</label>
                    <input type="date" id="taskDate">
                </div>

                <div class="recurring-options" id="recurringOptions">
                    <div class="form-group">
                        <label>Период повторения</label>
                        <select id="recurringType" onchange="toggleRecurringDetails()">
                            <option value="daily">Ежедневно</option>
                            <option value="weekly">Еженедельно</option>
                            <option value="monthly">Ежемесячно</option>
                        </select>
                    </div>

                    <div id="weeklyOptions" style="display: none;">
                        <label>Дни недели:</label>
                        <div class="weekdays-selector">
                            <label><span>Пн</span><input type="checkbox" value="1"></label>
                            <label><span>Вт</span><input type="checkbox" value="2"></label>
                            <label><span>Ср</span><input type="checkbox" value="3"></label>
                            <label><span>Чт</span><input type="checkbox" value="4"></label>
                            <label><span>Пт</span><input type="checkbox" value="5"></label>
                            <label><span>Сб</span><input type="checkbox" value="6"></label>
                            <label><span>Вс</span><input type="checkbox" value="0"></label>
                        </div>
                    </div>

                    <div id="monthlyOptions" style="display: none;">
                        <label>День месяца:</label>
                        <input type="number" id="monthDay" min="1" max="31" value="1">
                    </div>

                    <div class="form-group">
                        <label>Начало периода</label>
                        <input type="date" id="startDate">
                    </div>

                    <div class="form-group">
                        <label>Конец периода</label>
                        <input type="date" id="endDate">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="hideFromCalendar">
                            Не показывать в календаре
                        </label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Сохранить</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        let editingTaskId = null;

        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                          'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];

        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
            
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            let date = 1;
            let nextMonthDate = 1;
            
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
            
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    
                    if (i === 0 && j < adjustedFirstDay) {
                        const prevDate = daysInPrevMonth - adjustedFirstDay + j + 1;
                        cell.classList.add('other-month');
                        cell.innerHTML = `<div class="day-number">${prevDate}</div>`;
                    } else if (date > daysInMonth) {
                        cell.classList.add('other-month');
                        cell.innerHTML = `<div class="day-number">${nextMonthDate}</div>`;
                        nextMonthDate++;
                    } else {
                        const currentDateObj = new Date(year, month, date);
                        const today = new Date();
                        
                        if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
                            cell.classList.add('today');
                        }
                        
                        cell.innerHTML = `<div class="day-number">${date}</div>`;
                        cell.dataset.date = `${year}-${(month + 1).toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
                        cell.onclick = () => selectDate(cell.dataset.date);
                        
                        const tasksForDay = getTasksForDate(currentDateObj);
                        if (tasksForDay.length > 0) {
                            const tasksContainer = document.createElement('div');
                            tasksForDay.slice(0, 2).forEach(task => {
                                const taskElement = document.createElement('div');
                                taskElement.className = 'calendar-task';
                                taskElement.textContent = task.title;
                                tasksContainer.appendChild(taskElement);
                            });
                            cell.appendChild(tasksContainer);
                        }
                        
                        date++;
                    }
                    
                    row.appendChild(cell);
                }
                
                calendarBody.appendChild(row);
                if (date > daysInMonth) break;
            }
        }

        function getTasksForDate(date, includeHidden = false) {
            const dateStr = formatDate(date);
            const allTasks = [];
            
            tasks.forEach(task => {
                if (task.type === 'single' && task.date === dateStr) {
                    allTasks.push(task);
                } else if (task.type === 'recurring' && isTaskActiveOnDate(task, date)) {
                    if (includeHidden || !task.hideFromCalendar) {
                        allTasks.push(task);
                    }
                }
            });
            
            return allTasks.sort((a, b) => a.time.localeCompare(b.time));
        }

        function isTaskActiveOnDate(task, date) {
            const startDate = new Date(task.startDate);
            const endDate = task.endDate ? new Date(task.endDate) : null;
            
            if (date < startDate || (endDate && date > endDate)) {
                return false;
            }
            
            if (task.recurringType === 'daily') {
                return true;
            } else if (task.recurringType === 'weekly') {
                const dayOfWeek = date.getDay();
                return task.weekdays && task.weekdays.includes(dayOfWeek.toString());
            } else if (task.recurringType === 'monthly') {
                return date.getDate() === task.monthDay;
            }
            
            return false;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            
            document.querySelectorAll('.calendar td').forEach(td => {
                td.classList.remove('selected');
            });
            
            const selectedTd = document.querySelector(`[data-date="${dateStr}"]`);
            if (selectedTd) {
                selectedTd.classList.add('selected');
            }
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayNames = ['воскресенье', 'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота'];
            
            document.getElementById('selectedDate').textContent = 
                `${day} ${monthNames[month - 1]} ${year}, ${dayNames[date.getDay()]}`;
            
            displayTasksForDay(date);
        }

        function formatDuration(minutes) {
            if (!minutes || minutes < 0) return '';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            let result = '';
            if (h > 0) result += `${h} ч `;
            if (m > 0) result += `${m} мин`;
            return `(${result.trim()})`;
        }

        function displayTasksForDay(date) {
            const tasksForDay = getTasksForDate(date, true); // Включаем скрытые задачи
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            if (tasksForDay.length === 0) {
                taskList.innerHTML = '<li style="text-align: center; color: #7f8c8d;">Нет запланированных дел</li>';
                return;
            }
            
            tasksForDay.forEach(task => {
                const li = document.createElement('li');
                li.className = `task-item ${task.type === 'recurring' ? 'recurring' : ''}`;
                
                let taskInfo = `
                    <div class="task-time">${task.time} ${formatDuration(task.duration)}</div>
                    <div class="task-title">${task.title}</div>
                `;
                
                if (task.description) {
                    taskInfo += `<div style="font-size: 14px; color: #7f8c8d; margin-top: 4px;">${task.description}</div>`;
                }
                
                if (task.type === 'recurring') {
                    taskInfo += `<div style="font-size: 12px; color: #9b59b6; margin-top: 4px;">Периодическое</div>`;
                }
                
                taskInfo += `
                    <div class="task-actions">
                        <button onclick="editTask('${task.id}')">Редактировать</button>
                        <button class="delete" onclick="deleteTask('${task.id}')">Удалить</button>
                    </div>
                `;
                
                li.innerHTML = taskInfo;
                taskList.appendChild(li);
            });
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
            
            if (selectedDate) {
                const [year, month] = selectedDate.split('-').map(Number);
                if (year === currentDate.getFullYear() && month === currentDate.getMonth() + 1) {
                    selectDate(selectedDate);
                }
            }
        }

        function showAddTaskModal() {
            if (!selectedDate) {
                alert('Пожалуйста, выберите день в календаре');
                return;
            }
            
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Новое дело';
            document.getElementById('taskForm').reset();
            document.getElementById('taskDate').value = selectedDate;
            document.getElementById('taskModal').style.display = 'flex';
            toggleRecurringOptions();
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            document.getElementById('modalTitle').textContent = 'Редактировать дело';
            
            document.getElementById('taskType').value = task.type;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskTime').value = task.time;
            document.getElementById('taskDuration').value = task.duration || '';
            document.getElementById('taskDescription').value = task.description || '';
            
            if (task.type === 'single') {
                document.getElementById('taskDate').value = task.date;
            } else {
                document.getElementById('recurringType').value = task.recurringType;
                document.getElementById('startDate').value = task.startDate;
                document.getElementById('endDate').value = task.endDate || '';
                document.getElementById('hideFromCalendar').checked = task.hideFromCalendar || false;
                
                if (task.recurringType === 'weekly') {
                    document.querySelectorAll('.weekdays-selector input').forEach(cb => {
                        cb.checked = task.weekdays.includes(cb.value);
                    });
                } else if (task.recurringType === 'monthly') {
                    document.getElementById('monthDay').value = task.monthDay;
                }
            }
            
            toggleRecurringOptions();
            toggleRecurringDetails();
            document.getElementById('taskModal').style.display = 'flex';
        }

        function deleteTask(taskId) {
            if (confirm('Вы уверены, что хотите удалить это дело?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                generateCalendar();
                if (selectedDate) {
                    selectDate(selectedDate);
                }
            }
        }

        function toggleRecurringOptions() {
            const taskType = document.getElementById('taskType').value;
            const recurringOptions = document.getElementById('recurringOptions');
            const singleDateGroup = document.getElementById('singleDateGroup');
            
            if (taskType === 'recurring') {
                recurringOptions.style.display = 'block';
                singleDateGroup.style.display = 'none';
            } else {
                recurringOptions.style.display = 'none';
                singleDateGroup.style.display = 'block';
            }
        }

        function toggleRecurringDetails() {
            const recurringType = document.getElementById('recurringType').value;
            document.getElementById('weeklyOptions').style.display = 
                recurringType === 'weekly' ? 'block' : 'none';
            document.getElementById('monthlyOptions').style.display = 
                recurringType === 'monthly' ? 'block' : 'none';
        }

        function closeModal() {
            document.getElementById('taskModal').style.display = 'none';
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taskType = document.getElementById('taskType').value;
            const title = document.getElementById('taskTitle').value;
            const time = document.getElementById('taskTime').value;
            const duration = document.getElementById('taskDuration').value;
            const description = document.getElementById('taskDescription').value;
            
            if (!title || !time) {
                alert('Пожалуйста, заполните обязательные поля');
                return;
            }
            
            const taskData = {
                id: editingTaskId || Date.now().toString(),
                type: taskType,
                title: title,
                time: time,
                duration: duration,
                description: description
            };
            
            if (taskType === 'single') {
                taskData.date = document.getElementById('taskDate').value;
            } else {
                taskData.recurringType = document.getElementById('recurringType').value;
                taskData.startDate = document.getElementById('startDate').value || formatDate(new Date());
                taskData.endDate = document.getElementById('endDate').value;
                taskData.hideFromCalendar = document.getElementById('hideFromCalendar').checked;
                
                if (taskData.recurringType === 'weekly') {
                    taskData.weekdays = Array.from(document.querySelectorAll('.weekdays-selector input:checked'))
                        .map(cb => cb.value);
                } else if (taskData.recurringType === 'monthly') {
                    taskData.monthDay = parseInt(document.getElementById('monthDay').value);
                }
            }
            
            if (editingTaskId) {
                const index = tasks.findIndex(t => t.id === editingTaskId);
                tasks[index] = taskData;
            } else {
                tasks.push(taskData);
            }
            
            saveTasks();
            generateCalendar();
            if (selectedDate) {
                selectDate(selectedDate);
            }
            closeModal();
        });

        // Закрытие модального окна при клике вне его
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Инициализация
        generateCalendar();
        
        // Автоматически выбираем текущий день
        const today = new Date();
        const todayStr = formatDate(today);
        selectDate(todayStr);
    </script>
</body>
</html>
